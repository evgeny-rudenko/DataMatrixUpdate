declare @ALL_LOTS bit
set @ALL_LOTS =0

declare @USE_ALIENS bit
set @USE_ALIENS =1


declare @GOOD_NAME varchar (50)
set @GOOD_NAME = 'GOODNAMESEARCH'

IF OBJECT_ID('tempdb..#LOTS') IS NOT NULL
    DROP TABLE #LOTS

select ID_LOT 
into #lots
from LOT
where id_goods in (select id_goods from GOODS where name like @GOOD_NAME )
and LOT.QUANTITY_REM >0



SELECT 
G.NAME AS GOODS_NAME,
L.LOT_NAME,
L.INTERNAL_BARCODE,
L.QUANTITY_REM / SR.DENOMINATOR AS QUANTITY_REM,
L.PRICE_SAL,
ISNULL (KIZ.GTIN_SGTIN,'') AS KIZ,
KIZ.BARCODE,
'01'+ISNULL (KIZ.GTIN,'')+'21'+ISNULL(KIZ.SGTIN,'') AS KIZ_ARMK,
CASE WHEN KDI.ID_TABLE_ADD = 6 THEN KDI.QUANTITY ELSE KDI.QUANTITY*ISNULL(KDI.NUMERATOR,1)/ISNULL(KDI.DENOMINATOR,1) END AS KIZ_QTY_ADD,
SUM(CASE WHEN ISNULL(KDI_CH.ID_TABLE_ADD,0)= 6 THEN ISNULL(KDI_CH.QUANTITY,0) ELSE ISNULL(KDI_CH.QUANTITY,0)*ISNULL(KDI_CH.NUMERATOR,1)/ISNULL(KDI_CH.DENOMINATOR,1) END) AS KIZ_QTY_SUB,
CASE WHEN KDI.ID_TABLE_ADD = 6 THEN KDI.QUANTITY ELSE KDI.QUANTITY*ISNULL(KDI.NUMERATOR,1)/ISNULL(KDI.DENOMINATOR,1) END - 
SUM(CASE WHEN ISNULL(KDI_CH.ID_TABLE_ADD,0)= 6 THEN ISNULL(KDI_CH.QUANTITY,0) ELSE ISNULL(KDI_CH.QUANTITY,0)*ISNULL(KDI_CH.NUMERATOR,1)/ISNULL(KDI_CH.DENOMINATOR,1) END) AS KIZ_QTY_REM ,
KIZ.ID_KIZ_GLOBAL
FROM LOT L (NOLOCK) 
INNER JOIN STORE ST (NOLOCK) ON ST.ID_STORE=L.ID_STORE
INNER JOIN SCALING_RATIO SR (NOLOCK) ON SR.ID_SCALING_RATIO=L.ID_SCALING_RATIO
INNER JOIN GOODS G (NOLOCK)  ON G.ID_GOODS=L.ID_GOODS
LEFT JOIN KIZ_2_DOCUMENT_ITEM KDI (NOLOCK)  ON KDI.ID_DOCUMENT_ITEM_ADD=L.ID_DOCUMENT_ITEM_ADD
LEFT JOIN KIZ (NOLOCK)  ON KIZ.ID_KIZ_GLOBAL=KDI.ID_KIZ_GLOBAL
LEFT JOIN KIZ_2_DOCUMENT_ITEM KDI_CH (NOLOCK)  ON KDI_CH.ID_DOCUMENT_ITEM_ADD_PREV=KDI.ID_DOCUMENT_ITEM_ADD AND KDI_CH.ID_KIZ_GLOBAL=KDI.ID_KIZ_GLOBAL
WHERE (@ALL_LOTS=1 OR L.ID_LOT IN (SELECT ID_LOT FROM #LOTS))
AND L.ID_DOCUMENT_ITEM_ADD IS NOT NULL
AND (ST.ID_CONTRACTOR=DBO.FN_CONST_CONTRACTOR_SELF() OR @USE_ALIENS = 1)
GROUP BY G.NAME,L.LOT_NAME,L.INTERNAL_BARCODE,L.QUANTITY_REM,KIZ.GTIN_SGTIN,SR.DENOMINATOR,KIZ.BARCODE,KIZ.ID_KIZ_GLOBAL,L.PRICE_SAL,
CASE WHEN KDI.ID_TABLE_ADD = 6 THEN KDI.QUANTITY ELSE KDI.QUANTITY*ISNULL(KDI.NUMERATOR,1)/ISNULL(KDI.DENOMINATOR,1) END,
'01'+ISNULL (KIZ.GTIN,'')+'21'+ISNULL(KIZ.SGTIN,'')
ORDER BY G.NAME,L.LOT_NAME,L.INTERNAL_BARCODE


